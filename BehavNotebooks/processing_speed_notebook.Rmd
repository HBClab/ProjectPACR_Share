---
title: "processing_speed_measure"
author: "James"
date: "June 19, 2017"
output:
  html_document:
    toc: yes
    toc_float: yes
  html_notebook: default
  pdf_document: default
---

# Processing Speed Data Analysis
Pre and Post data for all available participants. Pre = 56, Post = 40

## Data Prep

### Load Requisite R Packages
note: some of these may not actually be used.

```{r}
library(ggplot2)
library(knitr)
library(lme4)
library(psych)
library(languageR) 
library(lmerTest) #give p-values from mixed models
library(scales) #for making percents on the y-axis of graphs
library(reshape2) #transfer from wide to long format
library(effects)
library(tidyverse)
```

### Read in the dataset (in current directory)
```{r}
ps_data = read.table("processing_speed_R.csv", header = TRUE, sep = ",")
```

### Omit missing data (e.g. didn't measure post session for several participants)
```{r}
ps_data = na.omit(ps_data)  
head(ps_data, n = 123) 
```


###Summary table by group and time
```{r}
ps_data %>% group_by(session,group) %>%
  summarise(N=n(),mean_DSST=mean(dsst),sd_DSST=sd(dsst),se_DSST=sd(dsst)/sqrt(n()-1),mean_pattern=mean(pattern_comp),sd_pattern=sd(pattern_comp),se_pattern=sd(pattern_comp)/sqrt(n()-1),mean_letter=mean(letter_comp),sd_letter=sd(letter_comp),se_letter=sd(letter_comp)/sqrt(n()-1)) %>% arrange(desc(session))  
```

### Omit the Undefined group from the data and specify group as a factor
-Undefined group are drop outs
```{r}
ps_data <- subset(ps_data,group=="Control" | group=="Experimental")
ps_data$group <- factor(ps_data$group)
contrasts(ps_data$group)
levels(ps_data$group)
```


## Pre Data Analysis


### Isolate the session to the pre session
-note low value for letter comp, otherwise mostly normal
```{r}
ps_data_pre <- subset(ps_data, session=="pre") 
ps_data_pre$session <- factor(ps_data_pre$session)
multi.hist(ps_data_pre[4:6])
```


### Box whisker plot raw data
```{r, message=FALSE, warning=FALSE}
ggplot(data = ps_data_pre, aes(x = "dsst", y = dsst)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_pre, aes(x = "pattern comparison", y = pattern_comp)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_pre, aes(x = "letter comparison", y = letter_comp)) + geom_boxplot() + facet_wrap(~group)
```

### Pre-Intervention zscore transform and composite
```{r}
ps_data_pre$dsst.z <-scale(ps_data_pre$dsst, center = TRUE, scale = TRUE)
ps_data_pre$letter_comp.z <-scale(ps_data_pre$letter_comp, center = TRUE, scale = TRUE)
ps_data_pre$pattern_comp.z <-scale(ps_data_pre$pattern_comp, center = TRUE, scale = TRUE)
ps_data_pre$procspeed.z <-rowMeans(ps_data_pre[,c("dsst.z","letter_comp.z","pattern_comp.z")],na.rm=TRUE)
```

### box whisker plot z-scores
-composite is slighly positively skeweed
```{r}
#ps_data_pre_long <- melt(ps_data_pre, id=c("subject","session","group"))
ggplot(data = ps_data_pre, aes(x = "dsst (z-score)", y = dsst.z)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_pre, aes(x = "pattern comparison (z-score)", y = pattern_comp.z)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_pre, aes(x = "letter comparison (z-score)", y = letter_comp.z)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_pre, aes(x = "composite (z-score)", y = procspeed.z)) + geom_boxplot() + facet_wrap(~group)
hist(ps_data_pre$procspeed.z)
```


## Post Data Analysis
### Isolate the session to the post session
```{r}
ps_data_post <- subset(ps_data, session=="post") 
ps_data_post$session <- factor(ps_data_post$session)
multi.hist(ps_data_post[4:6])
```


### Box whisker plot raw data
```{r, message=FALSE, warning=FALSE}
ggplot(data = ps_data_post, aes(x = "dsst", y = dsst)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_post, aes(x = "pattern comparison", y = pattern_comp)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_post, aes(x = "letter comparison", y = letter_comp)) + geom_boxplot() + facet_wrap(~group)
```

### zscore transform and composite
```{r}
ps_data_post$dsst.z <-scale(ps_data_post$dsst, center = TRUE, scale = TRUE)
ps_data_post$letter_comp.z <-scale(ps_data_post$letter_comp, center = TRUE, scale = TRUE)
ps_data_post$pattern_comp.z <-scale(ps_data_post$pattern_comp, center = TRUE, scale = TRUE)
ps_data_post$procspeed.z <-rowMeans(ps_data_post[,c("dsst.z","letter_comp.z","pattern_comp.z")],na.rm=TRUE)
```

### box whisker plot z-scores
-now composite slightly negatively skewed, interesting shift
```{r}
#ps_data_post_long <- melt(ps_data_post, id=c("subject","session","group"))
ggplot(data = ps_data_post, aes(x = "dsst (z-score)", y = dsst.z)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_post, aes(x = "pattern comparison (z-score)", y = pattern_comp.z)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_post, aes(x = "letter comparison (z-score)", y = letter_comp.z)) + geom_boxplot() + facet_wrap(~group)
ggplot(data = ps_data_post, aes(x = "composite (z-score)", y = procspeed.z)) + geom_boxplot() + facet_wrap(~group)
hist(ps_data_post$procspeed.z)
```



## Graph all data 

### spaghetti plot of raw scores
```{r}
#make pre and post appear in the right order
ps_data$session <- factor(ps_data$session, levels = c("pre", "post"))
ggplot(data = ps_data, aes(x = session, y = dsst, group = subject)) + geom_line() + geom_point() + facet_wrap(~group)
ggplot(data = ps_data, aes(x = session, y = pattern_comp, group = subject)) + geom_line() + geom_point() + facet_wrap(~group)
ggplot(data = ps_data, aes(x = session, y = letter_comp, group = subject)) + geom_line() + geom_point() + facet_wrap(~group)
```


###Put transformed pre and post back together for longitudinal
-can use rbind because columns match
```{r}
ps_data_longit<-rbind(ps_data_pre,ps_data_post)
ggplot(data = ps_data_longit, aes(x = session, y = procspeed.z, group = subject)) + geom_line() + geom_point() + facet_wrap(~group)
```


### specify subject as a factor for random effects model and set factor codings
```{r}
ps_data$subject <- as.factor(ps_data$subject)
ps_data_longit$session <-as.factor(ps_data_longit$session)
ps_data_longit$group <-as.factor(ps_data_longit$group)
levels(ps_data_longit$session)
contrasts(ps_data_longit$session) # 0=pre, 1=post
levels(ps_data_longit$group)  # 0=Control, 1=Experimental
```



###Example of longitudinal mixed effects model
-Dummy coding for time (session) and group  
Intercept=> Average score for Control group at pre-test  
Session=> Change Post-Pre for the reference (Control group)  
Coefficent for group=> (Pre of Experimental) - (Pre of Control)  
Session:group=> (Post-Pre for Experimental)-(Post-Pre for Control)  

```{r}
lmer_procspeed <- lmer(procspeed.z ~ session*group + (1 | subject), REML = FALSE, 
  data = ps_data_longit)
summary(lmer_procspeed)  

final_model=lmer_procspeed

# qq-plot: you should observe a good fit of the straight line
qqnorm(resid(final_model));qqline(resid(final_model))
hist(resid(final_model))

#If the model fits, then if you plot residuals against the fitted values, you should see random scatter. If the scatter is not random that means there's some other random or fixed effect that explains variation in your data that you're missing. So in plot below the dash line represents perfect fit by zero residual and the solid line represents actual residuals. Residuals ideally show random variation around perfect fit. 
plot(fitted(final_model), resid(final_model),
  xlab = "Fitted Values", ylab = "Residuals")
  abline(h=0, lty=2)
  lines(smooth.spline(fitted(final_model), resid(final_model)))

effect("session:group", final_model) -> ef
summary(ef)
as.data.frame(ef)->x
x$session<-factor(x$session,levels=c("pre","post"))
ggplot(x, aes(session, fit)) + geom_point() + facet_wrap(~group,nrow=1) + geom_errorbar(aes(ymin=fit-se, ymax=fit+se), width=0.4) + scale_y_continuous(name="Model Estimated DV") + theme_linedraw()
```

